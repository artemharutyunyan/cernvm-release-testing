\chapter{\cernvmreleasetesting Server Platform Setup}
\label{sec:serversetup}

\section{Introduction}
This section provides complete step by step instructions on how to setup and configure the \tapper server which are part of a basic working
\releasetesting environment by outlining the procedure for setting up the server, hence why this is called a \emph{walkthrough} document. 
This guide is intended for users familiar enough with computers and desktop environments to enter basic commands in a terminal and install 
various operating systems. 

\section{Red Hat Based Server Setup}
\subsection{Installing the system}
\subsection{Configuring the system}
\subsection{Installing the Tapper Server}
\subsection{Setting up Tapper Web Interface and Database}

\section{Debian Based Server Setup}
\subsection{Installing the system}
\subsection{Configuring the system}
\flushleft
\begin{enumerate}
\item For installing Debian, follow the instructions outlined in the sections ``Installing the system''~\ref{sec:debianinstall} and
``Configuring the system''~\ref{sec:debianconfig} for installation and configuration instructions with the only exception being that
the hostname should be something unique such as \emph{cernvm-debian6-server}, to indicate that it is running the \tapper server, 
{\bf again keep the hostname convention consistent}.
\end{enumerate}

\subsection{Installing the Tapper Server}
\begin{enumerate}
\item Next, execute the following commands to install necessary dependencies, \emph{from now on all commands require root privileges}.
\lstset{caption= Install Dependencies}
\begin{lstlisting}
$ apt-get update
$ apt-get install make
$ apt-get install subversion
\end{lstlisting}

\item Now, download the latest copy of the Tapper-Starerkit, which is an installer for Tapper from the \cernvmreleasetesting 
Google Code Project page
\lstset{caption= Download Tapper-Starterkit}
\begin{lstlisting}
$ svn checkout http://cernvm-release-testing.googlecode.com/svn/trunk/ \
cernvm-release-testing-read-only
\end{lstlisting}

\item Now edit the Makefile in the Tapper-Starterkit installer folder and configure variable TAPPER\_SERVER which 
is the hostname of the machine that is currently installing the starter-kit. For now disregard the TESTMACHINE 
variables, also \emph{make sure the variable TAPPER\_SERVER? is changed to TAPPER\_SERVER} you should have something
similar to this in the Makefile.
\lstset{caption= Makefile Configuration}
\begin{lstlisting}
# initial machine names
TAPPER_SERVER=cernvm-server
TESTMACHINE1=johnconnor
TESTMACHINE2=sarahconnor
TESTMACHINE3=bullock
\end{lstlisting}

\item After you have configured the Makefile in the installer folder, install the Tapper-Starterkit by executing the
following command, for any prompts during the installation leave them as default and press enter. {\bf During
the installation, you will be prompted for the mysql password, DO NOT ENTER a password here UNLESS you already have an
existing MySQL installation/database with a password set for the ``root'' account}
\lstset{caption= Install Tapper-Starterkit}
\begin{lstlisting}
$ make localsetup
\end{lstlisting}
\end{enumerate}

\subsection{Setting up Tapper Web Interface and Database}
\begin{enumerate}
\item Next you need to set a password for the root account of the mysql database\footnote{This will eventually be implemented in the makefile}
\lstset{caption= Set MySQL Root Password}
\begin{lstlisting}
# Example: mysqladmin -u root password abc123
mysqladmin -u root password <newpassword>
\end{lstlisting}

\item Now that the installion has completed and security issue has been dealt with, ensure that you can access the tapper web
interface is working by viewing it in your browser using the url,  
\url{http://localhost/tapper}\footnote{This can be accessed locally and remotely from other systems using the server hostname or IP address}

\item Next install phpmyadmin so that it's easy to administrate and configure the Tapper databases, \emph{if you are prompted to 
configure the database for phpmyadmin with dbconfig-common select {\bf NO} } 
\lstset{caption= Install PHPMyAdmin}
\begin{lstlisting}
$ apt-get update

# When prompted for the server to reconfigure automatically select apache2
# when prompted to configure the database with dbconfig-common select NO
$ apt-get install phpmyadmin
\end{lstlisting}

\item Now, manually add the configured test machines from created in the ``Test Client Platform Setup'' section to the
tapper database and set the test clients as active. This example is just using a single generic test machine, you will
have to repeat these commands for each test client and change the hostname \emph{cernvm-host} and the values for mem,
core,vendor, and has\_ecc as needed; the vendor can be AMD or Intel.
\lstset{caption= Adding Test Clients to Tapper Database}
\begin{lstlisting}
$ tapper-testrun newhost --name cernvm-host --active
$ mysql testrundb -utapper -ptapper
$ insert into host_feature(host_id, entry, value)  values \
((select id from host where name = 'cernvm-host'),     'mem',  4096);
$ insert into host_feature(host_id, entry, value)  values \
((select id from host where name = 'cernvm-host'),   'cores',     4);
$ insert into host_feature(host_id, entry, value)  values \
((select id from host where name = 'cernvm-host'),  'vendor', 'AMD');
$ insert into host_feature(host_id, entry, value)  values \
((select id from host where name = 'cernvm-host'), 'has_ecc',     0);
\end{lstlisting}


\item Next, send a sample test report to the tapper server, to ensure that the web interface, MCP, database, and reports
framework are all working by viewing the tapper reports in your browser at the following url, 
\url{http://localhost/tapper/reports} You should now see a report from the ``Machines''
cernvm-server, or whatever the hostname of the server is.
\lstset{caption= Send a Report to Server from Server}
\begin{lstlisting}
# Save the following in a file named demo_report.tap
$ vi demo_report.tap

	1..2
	# Tapper-Suite-Name: Tapper-Starterkit
	# Tapper-Suite-Version: 1.001
	# Tapper-Machine-Name: cernvm-server
	ok - Hello test world
	ok - Just another description

# Send the report to the tapper server using netcat
$ cat demo_report.tap | netcat -q7 -w1 cernvm-server 7357
\end{lstlisting}

\item Finally, ssh login to one of the test machine that was set up earlier, \emph{in our examples, cernvm-host} and send another 
sample test report to the tapper server, to ensure that the web interface, MCP, database, and reports framework are all working by
viewing the tapper reports in your browser at the following url: \url{http://localhost/tapper/reports} 
You should now see a report from the ``Machines'' cernvm-server and cernvm-host or whatever their respective hostnames are.
\lstset{caption= Send a Report to Server from a Test Client}
\begin{lstlisting}
# Save the following in a file named demo_report.tap
$ vi demo_report.tap

	1..2
	# Tapper-Suite-Name: Tapper-Starterkit
	# Tapper-Suite-Version: 1.001
	# Tapper-Machine-Name: cernvm-server
	ok - Hello test world
	ok - Just another description

# Send the report to the tapper server using netcat
$ cat demo_report.tap | netcat -q7 -w1 cernvm-server 7357
\end{lstlisting}

\end{enumerate}
